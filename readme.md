# Scala Telegram Wallet (STW)

![image](https://user-images.githubusercontent.com/630603/154652605-a4f74e2a-1225-4ec9-b82b-d756a362e3d9.png)

STW is a designed telegram wallet which is easily customize by coin developers to be executed via Telegram.

# Table of Contents
* [Usages](#usages)
* [Command](#commands)
* [Models](#models)


## Usages

### NodeJS and Redis

* Nodejs v16.0+
	* For Ubuntu: 
 ```
	sudo apt-get update
	sudo apt-get install build-essential libssl-dev
	curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.39.1/install.sh | bash
	source ~/.profile
	nvm install 16
	nvm alias default 16
	nvm use default
```
* [Redis](http://redis.io/) key-value store v5.0+ 

### Installation

Clone the repository and run `npm install` for all the dependencies to be installed:

```bash
	git clone https://github.com/scala-network/TelegramWallet.git stw
	cd stw
	npm install
```

### Configurations

Copy the `config.default.json` to `config.json` then view each options and change to match your preferred setup. Below are details for each keys

| Key | Description |
|---|---|
| [bot](#bot)		|
| bot.token | Insert telegram token generated by [@BotFather](#bot)  |
| bot.username | Username for bot generated by [@BotFather](#bot) |
| admins | User id for bot adminstration. Currently no administration define	|
| [rpc](#rpc)	|
| rpc.metaTTL | Expiry for each meta used for confirmation 	|
| rpc.server.address | RPC address 	|
| rpc.server.port | RPC port 	|


### Other Configurations

These configurations are predefine and can be overwriten via config.json

| Key | Description | Default value |
|---|---|---|
| [datasource](#datasource)		|
| datasource.engine | Your database engine to be use   | redis |

Below configuration keys are for redis engine 

| Key | Description | Default value |
|---|---|---|
| datasource.address | Redis address   | "127.0.0.1" |
| datasource.port | Redis port   | 6379 |
| datasource.db | Your database number   | 5 |
| datasource.keepalive | To set redis keep alive time  | 0 |
| datasource.auth |Your redis authentication  | false |

Configuration for sqlite (*experimental*)

| Key | Description | Default value |
|---|---|---|
| datasource.path | Path to sqlite file  | database.sqlite |

Configurations for log

| Key | Description | Default value |
|---|---|---|
| **log** |
| log.files |
| log.files.enabled | Enable logging to file | false |
| log.files.level | Logging for certain level and above only | error |
| log.files.directory | Logging file to which directory | logs |
| log.files.flushInterval | Interval for logging file to write | logs |
| log.console |
| log.console.level | Logging for certain level and above only  | info |
| log.console.colors | Logging to console with colors  | true |


### Bot

You must have a bot created. To create a bot message [@BotFather](https://t.me/botfather)

### RPC
RPC is how we communicate with the wallet. Must have a wallet rpc setup (find the coin's repo and build latest version from source). Below is an eg. for scala.

* Download latest [release](https://github.com/scala-network/Scala/releases)
* Run daemon via 

```./scalad```

* Create a wallet if you don't have one by using 

```./scala-wallet-cli```

* Run RPC as below

```./scala-wallet-rpc --disable-rpc-login --rpc-bind-port 18081 --wallet-file wallet --prompt-for-password```

*Currently we haven't tested on rpc with logins*

* To test you RPC is avaliable you can use netstat, curl or any other methods you find ease. Here is a way to test via curl

```curl http://127.0.0.1:18081/json_rpc -d '{"jsonrpc":"2.0","id":"0","method":"get_address","params":{"account_index":0,"address_index":[]}}' -H 'Content-Type: application/json'```

### Running

Once everything is setup run
```node app.js```

## Commands
Commands are message that are sent to bot to execute a certain function or features. Commands are accepted only with a prefix `/`
Each commands can be set as authorized for either in group only, user action only or both. Below are the commands available.

* /help - Show all commands
* /create - Create a new account
* /balance - Check current wallet balance
* /address - Reveal you coin wallet address
* /withdraw - Withdraw coin from wallet to another coin address
* /tip - Sends coin base on your setup tip amount
* /info - Display information about wallet and account
* /submit - Once withdraw and transfer is done you need to reply submit with id to confirm payment
* /version - Display current server's version
* /height - Display wallet's height
* /set - Configure settings. Amongst settings avaliable
    * tip - Set tip amount
    * tip_submit - Disable or enable sent confirmation for tip
    * rain - Set tip amount
    * rain_submit - Disable or enable sent confirmation for rain
* /rain - Airdrop coin to users in group who have registered with the coin bot

### Commands Development

To create a new command, you must follow these rules.

1. Your command name must be unique
2. Let say your command name is hello, then your command file name should be helloCommand.js
3. Your command should be in /src/commands folder
4. The command class should have these getter
	a. description - returns what your command does in string
	b. name - returns the name of your command in string
5. Must extend BaseCommand
6. Must have run method which accepts [telegraf context](https://github.com/telegraf/telegraf/blob/develop/README.md#context-class)
7. Set `enable` class variable @ property to true allowing the command to be executed

eg.

```nodejs
const BaseCommand = requires('./BaseCommand');

class HelloCommand extends BaseCommand {
	enabled = true;

	get description() {
		return "Prints hello";
	}

	get name() {
		return "hello";
	}

	async run(ctx) {
		ctx.reply("hello");
	}
}

```

### Optional class methods

1. auth - Limits by return either true or false. Accepts a [telegraf context](https://github.com/telegraf/telegraf/blob/develop/README.md#context-class) object.
2. beforeRun - Executed before the run method is called. Accepts [telegraf context](https://github.com/telegraf/telegraf/blob/develop/README.md#context-class) and next callback to continue.


```nodejs
	/* Allowing only groups to execute */
	auth(ctx) {
		return ctx.appRequest.is.group;
	}

	/* Modify context before running it */
	beforeRun(ctx, next) {
		ctx.modifiedContext = () => { return "Hello };
		next(ctx);
	}
}

```

### Telegraf context extensions (appRequest)

appRequest allows to gain about request information from user.

1. is - object allows to identify either admin, a group or the message is personally to user
2. action - can see what the actual command is called
3. query - can see the actual query being made
4. args - the queries in array

eg. of a chat transpose to appRequest

```/tip username 1000```

* `action` - `tip`
* `query` - `username 1000`
* `args` - [`username`,`1000`]


### Calling models into commands

You can load a model by calling `this.loadModel(<model name>);`. This will return model from models directory base on engine. Currently only redis engine is tested and working.


## Models

There are 2 layers for the model
1. The main model - Main interface class
2. The query layer - The abstraction class base on which engine is use

### Calling RPC Calls for Coin

All rpc requests is base on coin class located at /src/coins. Currently we have XLA only.

To call coin spesific methods or properties use this.Coin inside command

You can try to add the scala bot https://t.me/scalawalletbot or join our Telegram community to experience it https://t.me/scalaofficial
